<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofertas Especiales del dia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        /* Estilos CSS Puros y Mejoras */

        /* 1. Efecto Neon para el Badge de Descuento */
        .neon-discount {
            box-shadow: 0 0 5px rgba(255, 69, 0, 0.9), 0 0 10px rgba(255, 69, 0, 0.7), 0 0 15px rgba(255, 69, 0, 0.5);
            animation: pulse-neon 2s infinite alternate;
            font-size: 1.125rem;
        }

        @keyframes pulse-neon {
            0% {
                box-shadow: 0 0 5px rgba(255, 69, 0, 0.9);
            }

            100% {
                box-shadow: 0 0 15px rgba(255, 69, 0, 1), 0 0 20px rgba(255, 69, 0, 0.8);
            }
        }

        /* 2. Mejora en la Card y el Glow de Hover */
        .card-hover {
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .card-hover:hover {
            transform: scale(1.03);
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.7);
        }

        /* Posicionamiento del Badge de Descuento */
        .discount-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
        }

        /* 3. Ajuste del Glassmorphism para mejor contraste */
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 4. Spinner de Carga */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #f9fafb;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 5. Imagen con Aspect Ratio */
        .image-container {
            width: 100%;
            aspect-ratio: 1/1;
        }

        /* 6. Estilo del Input de Búsqueda */
        #search-input {
            transition: box-shadow 0.3s ease-in-out;
        }

        #search-input:focus {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            /* Glow azul al enfocar */
            outline: none;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 min-h-screen p-4 font-sans antialiased">
    <div class="container mx-auto max-w-7xl">

        <header class="text-center mb-10 pt-12 animate__animated animate__fadeInDown">
            <h1
                class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mb-4 tracking-tight">
                🔥 Ofertas Destacadas
            </h1>
            <p class="text-xl text-indigo-300 max-w-3xl mx-auto italic">
                Descubre **descuentos exclusivos** y productos de alta calidad a diario.
            </p>
        </header>

        <div class="mb-12 max-w-xl mx-auto animate__animated animate__fadeInUp">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-300 z-10"></i>
                <input type="text" id="search-input" placeholder="Buscar producto por título..."
                    class="w-full py-4 pl-12 pr-6 text-white text-lg bg-gray-800/50 glass-effect rounded-xl placeholder-blue-300/80 border border-blue-600/50 focus:border-blue-400">
            </div>
        </div>

        <div id="loading" class="flex flex-col justify-center items-center py-24">
            <div class="loading-spinner"></div>
            <span class="mt-4 text-white text-xl animate__animated animate__pulse animate__infinite">Cargando ofertas al
                mejor precio...</span>
        </div>

        <div id="error" class="hidden text-center py-12 animate__animated animate__shakeX">
            <div class="bg-red-900/40 glass-effect rounded-xl p-8 max-w-lg mx-auto shadow-2xl border-red-700">
                <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
                <h2 class="text-3xl font-bold text-white mb-3">¡Algo salió mal!</h2>
                <p class="text-red-200 mb-6">No pudimos cargar los productos. Intenta nuevamente.</p>
                <button id="retry-btn"
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-xl transition-all duration-300 shadow-lg">
                    Reintentar
                </button>
            </div>
        </div>

        <div id="no-results" class="hidden text-center py-16">
            <i class="fas fa-box-open text-blue-400 text-6xl mb-4"></i>
            <h2 class="text-3xl font-bold text-white mb-2">Sin coincidencias</h2>
            <p class="text-blue-200">No encontramos productos que coincidan con tu búsqueda.</p>
        </div>

        <div id="products-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </div>
    </div>

    <script>
        // Almacén global para todos los productos cargados
        let allProducts = [];

        // Función auxiliar para eliminar acentos (diacríticos) y convertir a minúsculas
        function removeAccents(str) {
            // Normaliza la cadena (descomposición canónica) y elimina los diacríticos
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        // Función para formatear el texto de descuento (ej: '35' -> '-35%')
        function formatDiscount(discount) {
            if (!discount) return '';
            let formatted = String(discount).trim();
            if (!formatted.startsWith('-')) formatted = `-${formatted}`;
            if (!formatted.endsWith('%')) formatted += '%';
            return formatted;
        }

        // Función para acortar el título
        function shortenTitle(title, maxLength = 50) {
            if (title.length <= maxLength) return title;
            return title.substring(0, maxLength) + '...';
        }

        // Función para crear una card de producto
        function createProductCard(product) {
            return `
                <div class="card-hover glass-effect rounded-2xl overflow-hidden h-full flex flex-col shadow-2xl animate__animated animate__fadeInUp">
                    
                    <div class="relative image-container overflow-hidden bg-gray-800">
                        
                        <div class="discount-badge">
                            <span class="neon-discount bg-red-600 text-white font-extrabold px-4 py-2 rounded-full shadow-xl transform rotate-3 inline-block">
                                ${formatDiscount(product.discount)}
                            </span>
                        </div>
                        
                        <div class="absolute inset-0 bg-black/10 transition-colors duration-300"></div>
    
                        <img 
                            src="${product.image_url}" 
                            alt="${product.title}"
                            class="w-full h-full object-cover transition-transform duration-700 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/400x400/111827/ffffff?text=Producto+en+Oferta'"
                        >
                    </div>
                    
                    <div class="p-5 flex-grow flex flex-col">
                        <h3 class="text-white font-bold text-xl mb-3 line-clamp-2">
                            ${shortenTitle(product.title)}
                        </h3>
                        
                        <p class="text-indigo-200 text-sm mb-5 flex-grow line-clamp-3">
                            ${product.description || 'Producto en oferta exclusiva. ¡Aprovecha ahora!'}
                        </p>
                        
                        <div class="mt-auto pt-4 border-t border-white/10">
                            <a 
                                href="${product.amznUrl}" 
                                target="_blank" 
                                class="offer-button block w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white text-center font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.05] shadow-lg focus:outline-none focus:ring-4 focus:ring-purple-500/50"
                            >
                                ¡Ver Oferta Ahora!
                                <i class="fas fa-arrow-circle-right ml-2"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para renderizar un conjunto de productos
        function renderProducts(products) {
            const productsGrid = document.getElementById('products-grid');
            const noResultsElement = document.getElementById('no-results');

            if (products.length === 0) {
                productsGrid.classList.add('hidden');
                noResultsElement.classList.remove('hidden');
            } else {
                noResultsElement.classList.add('hidden');
                productsGrid.classList.remove('hidden');

                const productsHTML = products.map(createProductCard).join('');
                productsGrid.innerHTML = productsHTML;
            }
        }

        // Función para filtrar los productos (LÓGICA DE BÚSQUEDA INSENSIBLE A ACENTOS)
        function filterProducts(searchTerm) {
            // Normaliza el término de búsqueda
            const normalizedTerm = removeAccents(searchTerm);

            if (normalizedTerm === '') {
                renderProducts(allProducts);
                return;
            }

            // Filtra los productos comparando los títulos también normalizados
            const filtered = allProducts.filter(product => {
                if (!product.title) return false;

                // Normaliza el título del producto antes de la comparación
                const normalizedTitle = removeAccents(product.title);

                // Verifica si el título normalizado incluye el término normalizado
                return normalizedTitle.includes(normalizedTerm);
            });

            renderProducts(filtered);
        }

        // Función principal para cargar los productos desde la API
        async function loadProducts() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const productsGrid = document.getElementById('products-grid');

            try {
                loadingElement.classList.remove('hidden');
                productsGrid.classList.add('hidden');
                errorElement.classList.add('hidden');
                document.getElementById('no-results').classList.add('hidden');

                // Hacer la petición a tu API endpoint
                const response = await fetch('/api/products');

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.data && data.data.products) {

                    // Almacenar todos los productos en la variable global
                    allProducts = data.data.products;

                    loadingElement.classList.add('hidden');

                    // Renderizar la lista inicial (todos los productos)
                    renderProducts(allProducts);

                    productsGrid.classList.add('animate__animated', 'animate__fadeInUp');

                } else {
                    throw new Error('Formato de respuesta inválido o sin productos');
                }

            } catch (error) {
                console.error('Error al cargar productos:', error);

                loadingElement.classList.add('hidden');
                productsGrid.classList.add('hidden');
                errorElement.classList.remove('hidden');
            }
        }

        // Inicialización y eventos
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();

            // Configurar botón de reintento
            document.getElementById('retry-btn').addEventListener('click', loadProducts);

            // Configurar el input de búsqueda para filtrar al escribir
            const searchInput = document.getElementById('search-input');

            // Usamos 'input' para filtrar en tiempo real mientras el usuario escribe
            searchInput.addEventListener('input', (e) => {
                filterProducts(e.target.value);
            });
        });
    </script>
</body>

</html>